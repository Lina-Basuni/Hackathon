// HealthSnap Prisma Schema
// Database: SQLite (easily swappable to PostgreSQL for production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ===========================================
// PATIENT MANAGEMENT
// ===========================================

model Patient {
  id              String    @id @default(cuid())
  name            String
  email           String    @unique
  phone           String?
  dateOfBirth     DateTime?
  sex             String?   // male | female | other
  knownConditions String?   // JSON: ["diabetes", "hypertension", etc.]
  medications     String?   // JSON: [{name, dosage, frequency}]
  createdAt       DateTime  @default(now())

  // Relations
  voiceNotes    VoiceNote[]
  appointments  Appointment[]
  reports       Report[]

  @@index([email])
}

// ===========================================
// VOICE NOTES & ANALYSIS
// ===========================================

model VoiceNote {
  id          String   @id @default(cuid())
  patientId   String
  audioUrl    String?  // Path to stored audio file or blob URL
  transcript  String?  // Speech-to-text result
  duration    Int      @default(0) // Duration in seconds
  createdAt   DateTime @default(now())

  // Relations
  patient        Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  riskAssessment RiskAssessment?

  @@index([patientId])
  @@index([createdAt])
}

model RiskAssessment {
  id                 String   @id @default(cuid())
  voiceNoteId        String   @unique

  // Extracted data
  riskFlags          String   // JSON: [{flag, severity, description}]
  symptomsExtracted  String   // JSON: [{symptom, duration, severity, location}]
  vitalsMentioned    String?  // JSON: {bloodPressure, heartRate, temperature, etc.}

  // Clinical assessment
  overallAcuity      String   // routine | urgent | emergent
  redFlags           String?  // JSON: ["chest pain at rest", "difficulty breathing", etc.]

  // AI confidence
  confidence         Float    @default(0.85) // 0-1 scale

  createdAt          DateTime @default(now())

  // Relations
  voiceNote       VoiceNote        @relation(fields: [voiceNoteId], references: [id], onDelete: Cascade)
  clinicalSummary ClinicalSummary?
  nextSteps       NextSteps?
  report          Report?

  @@index([overallAcuity])
}

model ClinicalSummary {
  id                  String   @id @default(cuid())
  riskAssessmentId    String   @unique

  chiefComplaint      String   // Main reason for visit
  summaryText         String   // Narrative summary for clinicians
  keyFindings         String   // JSON: ["finding1", "finding2", etc.]
  timeline            String?  // Description of symptom progression
  pertinentNegatives  String?  // JSON: ["no fever", "no chest pain", etc.]

  createdAt           DateTime @default(now())

  // Relations
  riskAssessment RiskAssessment @relation(fields: [riskAssessmentId], references: [id], onDelete: Cascade)
  report         Report?
}

model NextSteps {
  id                        String   @id @default(cuid())
  riskAssessmentId          String   @unique

  recommendedAction         String   // Primary recommendation
  urgencyTimeframe          String   // "within 24 hours", "within 1 week", etc.
  reasoning                 String   // Why this recommendation

  patientInstructions       String   // JSON: ["instruction1", "instruction2", etc.]
  warningSigns              String   // JSON: ["sign1", "sign2", etc.] - when to seek immediate care
  selfCareRecommendations   String?  // JSON: ["rest", "hydration", etc.]

  specialistTypeRecommended String?  // cardiology, pulmonology, etc.

  createdAt                 DateTime @default(now())

  // Relations
  riskAssessment RiskAssessment @relation(fields: [riskAssessmentId], references: [id], onDelete: Cascade)
  report         Report?
}

// ===========================================
// REPORTS
// ===========================================

model Report {
  id                String   @id @default(cuid())
  patientId         String
  riskAssessmentId  String   @unique
  clinicalSummaryId String   @unique
  nextStepsId       String   @unique

  // Report status
  status            String   @default("draft") // draft | final | sent

  // Sharing with doctor
  sentToDoctor      String?  // Doctor ID or name
  sentAt            DateTime?

  createdAt         DateTime @default(now())

  // Relations
  patient         Patient         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  riskAssessment  RiskAssessment  @relation(fields: [riskAssessmentId], references: [id], onDelete: Cascade)
  clinicalSummary ClinicalSummary @relation(fields: [clinicalSummaryId], references: [id], onDelete: Cascade)
  nextSteps       NextSteps       @relation(fields: [nextStepsId], references: [id], onDelete: Cascade)
  appointments    Appointment[]

  @@index([patientId])
  @@index([status])
}

// ===========================================
// DOCTORS & SCHEDULING
// ===========================================

model Doctor {
  id                String   @id @default(cuid())
  name              String
  specialty         String   // primary-care, cardiology, pulmonology, gastroenterology, etc.
  hospital          String?
  location          String?  // City, State

  // Additional info
  languages         String?  // JSON: ["English", "Spanish", etc.]
  acceptedInsurance String?  // JSON: ["Aetna", "Blue Cross", etc.]

  // Profile
  rating            Float    @default(4.5)
  yearsExperience   Int      @default(5)
  bio               String?
  imageUrl          String?

  // Education & Credentials
  education         String?  // JSON: [{degree, institution, year}]
  certifications    String?  // JSON: ["Board Certified", etc.]

  // Availability
  available         Boolean  @default(true)

  createdAt         DateTime @default(now())

  // Relations
  timeSlots    TimeSlot[]
  appointments Appointment[]
  reviews      DoctorReview[]

  @@index([specialty])
  @@index([available])
  @@index([location])
}

model DoctorReview {
  id        String   @id @default(cuid())
  doctorId  String

  rating    Float    // 1-5 stars
  comment   String?
  author    String   // Patient name or "Anonymous"

  createdAt DateTime @default(now())

  // Relations
  doctor Doctor @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@index([doctorId])
}

model TimeSlot {
  id            String    @id @default(cuid())
  doctorId      String

  // Time information
  date          DateTime  // Date of the slot (date portion only)
  startTime     String    // "09:00" format
  endTime       String    // "09:30" format
  duration      Int       @default(30) // Duration in minutes

  // Status
  isBooked      Boolean   @default(false)
  isBlocked     Boolean   @default(false) // For doctor-blocked times

  createdAt     DateTime  @default(now())

  // Relations
  doctor      Doctor       @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  appointment Appointment?

  @@unique([doctorId, date, startTime])
  @@index([doctorId])
  @@index([date])
  @@index([isBooked])
}

model Appointment {
  id          String    @id @default(cuid())
  patientId   String
  doctorId    String
  timeSlotId  String    @unique
  reportId    String?   // Optional attached report

  // Appointment details
  reason      String    // Reason for visit
  type        String    @default("in-person") // in-person | video | phone
  status      String    @default("pending") // pending | confirmed | completed | cancelled
  notes       String?   // Additional notes from patient

  // Confirmation
  confirmationCode String? @unique // e.g., "HS-ABC123"

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  patient  Patient   @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor   Doctor    @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  timeSlot TimeSlot  @relation(fields: [timeSlotId], references: [id], onDelete: Cascade)
  report   Report?   @relation(fields: [reportId], references: [id], onDelete: SetNull)

  @@index([patientId])
  @@index([doctorId])
  @@index([status])
  @@index([confirmationCode])
}
